import express from "express";
import dotenv from "dotenv";
import crypto from "crypto";
import axios from "axios";

dotenv.config();

const app = express();

// ===== ENV =====
const PORT = 3100
const VERIFY_TOKEN = process.env.INSTAGRAM_VERIFY_TOKEN || "itegram_maxfiy_kalit_998";
const META_APP_SECRET = process.env.META_APP_SECRET || "";
const SKIP_SIGNATURE = process.env.SKIP_SIGNATURE === "1";

// Telegram (ixtiyoriy)
const TG_BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN || "";
const TG_CHAT_ID = process.env.CHAT_ID || "";

// ===== Helpers =====
function truncate(str, max = 9000) {
  if (!str) return "";
  return str.length > max ? str.slice(0, max) + "â€¦(truncated)" : str;
}

function safeHeaders(headers) {
  const h = { ...headers };
  if (h.authorization) h.authorization = "***";
  if (h.cookie) h.cookie = "***";
  return h;
}

function shortJson(obj, max = 12000) {
  try {
    return truncate(JSON.stringify(obj, null, 2), max);
  } catch {
    return "[unserializable]";
  }
}

async function telegramSend(text) {
  if (!TG_BOT_TOKEN || !TG_CHAT_ID) return;
  try {
    await axios.post(`https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage`, {
      chat_id: TG_CHAT_ID,
      text: truncate(text, 3500),
      disable_web_page_preview: true,
    });
  } catch (e) {
    console.error("Telegram send failed:", e?.response?.data || e?.message);
  }
}

// ===== RAW body capture =====
app.use(
  express.json({
    limit: "10mb",
    verify: (req, _res, buf) => {
      req.rawBody = buf; // Buffer
    },
  })
);

app.use(
  express.urlencoded({
    extended: true,
    limit: "10mb",
    verify: (req, _res, buf) => {
      req.rawBody = buf; // Buffer
    },
  })
);

// ===== Signature verify (Meta) =====
function computeSignature(rawBodyBuffer) {
  // returns sha256=<hex>
  return (
    "sha256=" +
    crypto.createHmac("sha256", META_APP_SECRET).update(rawBodyBuffer).digest("hex")
  );
}

function verifyMetaSignature(req) {
  const signature = req.header("X-Hub-Signature-256");

  // GET verifyâ€™da signature boâ€˜lmaydi
  if (req.method === "GET") return true;

  if (SKIP_SIGNATURE) {
    console.warn("âš ï¸ SKIP_SIGNATURE=1 â€” signature check skipped (DEV MODE)");
    return true;
  }

  if (!META_APP_SECRET) {
    console.warn("âš ï¸ META_APP_SECRET is empty â€” signature check skipped (NOT RECOMMENDED)");
    return true;
  }

  if (!signature) return false;

  const raw = req.rawBody || Buffer.from("");
  const expected = computeSignature(raw);

  const a = Buffer.from(expected);
  const b = Buffer.from(signature);
  if (a.length !== b.length) return false;

  return crypto.timingSafeEqual(a, b);
}

// ===== Request logger middleware (faqat webhook route) =====
app.use((req, res, next) => {
  if (req.originalUrl?.startsWith("/instagram/webhook")) {
    const raw = req.rawBody ? req.rawBody.toString("utf8") : "";
    console.log("=============== WEBHOOK HIT ===============");
    console.log("TIME:", new Date().toISOString());
    console.log("METHOD:", req.method);
    console.log("URL:", req.originalUrl);
    console.log("HEADERS:", safeHeaders(req.headers));
    console.log("RAW:", truncate(raw, 8000));
    console.log("BODY:", truncate(JSON.stringify(req.body), 8000));
    console.log("===========================================");

    res.on("finish", () => {
      console.log("WEBHOOK RESPONSE STATUS:", res.statusCode);
    });
  }
  next();
});

// ===== ROUTES =====

// Health
app.get("/health", (_req, res) => res.status(200).send("OK"));

// 1) Verify (Meta tekshiradi)
app.get("/instagram/webhook", (req, res) => {
  const mode = req.query["hub.mode"];
  const token = req.query["hub.verify_token"];
  const challenge = req.query["hub.challenge"];

  console.log("=== VERIFY GET ===", {
    mode,
    token: token ? "YES" : "NO",
    challenge,
  });

  if (mode === "subscribe" && token === VERIFY_TOKEN) {
    console.log("âœ… Webhook muvaffaqiyatli tasdiqlandi!");
    return res.status(200).send(challenge || "");
  }

  console.log("âŒ Tasdiqlash xatosi! Noto'g'ri token.");
  return res.sendStatus(403);
});

// 2) Webhook (event qabul qilish)
app.post("/instagram/webhook", async (req, res) => {
  const ok = verifyMetaSignature(req);
  console.log("SIGNATURE OK:", ok ? "YES âœ…" : "NO âŒ");

  if (!ok) {
    console.log("âŒ Invalid signature â€” 401");
    return res.status(401).send("Invalid signature");
  }

  const raw = req.rawBody ? req.rawBody.toString("utf8") : "";
  const event = req.body;

  // FULL LOG
  console.log("\nðŸ”¥ --------------- YANGI WEBHOOK KELDI --------------- ðŸ”¥");
  console.log(shortJson(event, 20000));

  // Deep parse
  const entries = event?.entry;
  if (Array.isArray(entries)) {
    console.log(`âœ… entry count: ${entries.length}`);

    entries.forEach((entry, i) => {
      console.log(`--- ENTRY[${i}] ---`);
      console.log(shortJson(entry, 20000));

      if (Array.isArray(entry?.changes)) {
        console.log(`ENTRY[${i}] changes: ${entry.changes.length}`);
        entry.changes.forEach((ch, j) => {
          console.log(`  - CHANGE[${j}] field=${ch?.field ?? "N/A"}`);
          console.log(`    value=${truncate(JSON.stringify(ch?.value), 20000)}`);
        });
      }

      if (Array.isArray(entry?.messaging)) {
        console.log(`ENTRY[${i}] messaging: ${entry.messaging.length}`);
        entry.messaging.forEach((m, j) => {
          const sender = m?.sender?.id;
          const recipient = m?.recipient?.id;
          const text = m?.message?.text;
          const mid = m?.message?.mid;
          console.log(
            `  - MSG[${j}] sender=${sender ?? "N/A"} recipient=${recipient ?? "N/A"} mid=${mid ?? "N/A"}`
          );
          if (text) console.log(`    text=${truncate(String(text), 3000)}`);
          console.log(`    payload=${truncate(JSON.stringify(m), 20000)}`);
        });
      }

      if (!entry?.changes && !entry?.messaging) {
        console.log(`ENTRY[${i}] unknown format (no changes[], no messaging[])`);
      }
    });
  } else {
    console.log("âš ï¸ event.entry yoâ€˜q yoki array emas");
  }

  console.log("ðŸ”¥ ---------------------------------------------------- ðŸ”¥\n");

  // Telegramga ham yuboramiz (ixtiyoriy)
  await telegramSend(
    `IG webhook âœ…\nobject=${event?.object ?? "N/A"}\nraw=${truncate(raw, 3000)}`
  );

  return res.status(200).send("EVENT_RECEIVED");
});

// 3) DEV helper: signature yasab berish endpointi (faqat dev uchun!)
app.post("/dev/signature", (req, res) => {
  if (!META_APP_SECRET) return res.status(400).json({ error: "META_APP_SECRET missing" });

  const raw = req.rawBody || Buffer.from(JSON.stringify(req.body || {}));
  const sig = computeSignature(raw);

  return res.json({
    signatureHeader: { "X-Hub-Signature-256": sig },
    note: "Use --data-binary when sending curl",
  });
});

// ===== Start =====
const server = app.listen(PORT, () => {
  console.log(`âœ… Express listening on :${PORT}`);
  console.log(`Health:  http://localhost:${PORT}/health`);
  console.log(`Webhook:  http://localhost:${PORT}/instagram/webhook`);
  console.log(`SKIP_SIGNATURE=${SKIP_SIGNATURE ? "1 (DEV)" : "0 (PROD)"}`);
});

// Error handler
server.on("error", (err) => {
  console.error("âŒ Server start error:", err);
});

// Signals (PM2 loop diagnostika uchun)
process.on("SIGINT", () => {
  console.log("ðŸ›‘ SIGINT received. Shutting down...");
  process.exit(0);
});
process.on("SIGTERM", () => {
  console.log("ðŸ›‘ SIGTERM received. Shutting down...");
  process.exit(0);
});
